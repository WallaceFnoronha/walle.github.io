<!--
Gym Progress Tracker ‚Äì Single HTML file (desktop + iPhone)
Backend: Google Apps Script (Web App) connected to your Google Sheet

=============================================
1) HOW TO SET UP THE GOOGLE SHEET
=============================================
Create a spreadsheet with two tabs (sheet names in bold):

A) **Cadastro** (your exercise catalog)
Header row (A1:F1):
INDEX | TREINO | SERIE | EXERCICIO | SERIES | REPETICOES
Example row:
1 | Adapta√ß√£o | Peito/Triceps | Mobilidade articular (com elastico) | 2 | 10

B) **Historico** (daily logs)
Header row (A1:I1):
TIMESTAMP | DATA | TREINO | SERIE | EXERCICIO | SERIES | REPETICOES | PESO | OBS

- DATA format: YYYY-MM-DD (e.g., 2025-09-04)
- PESO: number you lifted for that exercise on that day
- OBS: optional notes

====================================================
2) ADD THIS APPS SCRIPT TO THE SPREADSHEET (BACKEND)
====================================================
Extensions ‚Üí Apps Script ‚Üí paste the code below into Code.gs, then Deploy ‚Üí New deployment ‚Üí Type: Web app ‚Üí Execute as: Me ‚Üí Who has access: Anyone with the link.
Copy the Web app URL and paste it into this HTML (open it in your browser) under Settings ‚Üí API URL.

----------------- Code.gs (copy all) -----------------
const SHEET_PLAN = 'Cadastro';
const SHEET_HISTORY = 'Historico';

function _asObjects_(sheetName) {
  const sh = SpreadsheetApp.getActive().getSheetByName(sheetName);
  const rng = sh.getDataRange();
  const values = rng.getValues();
  if (values.length < 2) return [];
  const headers = values[0].map(h => String(h).trim());
  return values.slice(1).filter(r => r.join('').trim() !== '').map(row => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });
}

function _appendRows_(sheetName, rows, headers) {
  const sh = SpreadsheetApp.getActive().getSheetByName(sheetName);
  if (!sh) throw new Error('Sheet not found: ' + sheetName);
  if (!rows || !rows.length) return 0;
  const existingHeaders = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  // Ensure headers order matches provided headers
  const indexMap = headers.map(h => existingHeaders.indexOf(h) + 1);
  const data = rows.map(obj => headers.map(h => obj[h]));
  sh.getRange(sh.getLastRow()+1, 1, data.length, existingHeaders.length).setValues(
    data.map(row => {
      // pad row to full width
      const full = new Array(existingHeaders.length).fill('');
      headers.forEach((h, i) => { const colIdx = existingHeaders.indexOf(h); if (colIdx >= 0) full[colIdx] = row[i]; });
      return full;
    })
  );
  return rows.length;
}

function doGet(e) {
  const params = e && e.parameter ? e.parameter : {};
  const action = (params.action || 'plan').toLowerCase();
  try {
    if (action === 'plan') {
      // Return all Cadastro rows
      const plan = _asObjects_(SHEET_PLAN);
      return _json({ ok: true, plan });
    }
    if (action === 'history') {
      const date = params.date || '';
      const hist = _asObjects_(SHEET_HISTORY).filter(r => {
        if (!date) return true;
        const d = (r['DATA'] || '').toString();
        return d === date;
      });
      return _json({ ok: true, history: hist });
    }
    return _json({ ok: false, error: 'Unknown action' }, 400);
  } catch (err) {
    return _json({ ok: false, error: err.message || String(err) }, 500);
  }
}

function doPost(e) {
  try {
    const body = e && e.postData && e.postData.contents ? e.postData.contents : '{}';
    const data = JSON.parse(body);
    const rows = Array.isArray(data.rows) ? data.rows : [];
    const now = new Date();
    const headers = ['TIMESTAMP','DATA','TREINO','SERIE','EXERCICIO','SERIES','REPETICOES','PESO','OBS'];
    const prepared = rows.map(r => ({
      'TIMESTAMP': now,
      'DATA': r.DATA || r.data || '',
      'TREINO': r.TREINO || r.treino || '',
      'SERIE': r.SERIE || r.serie || '',
      'EXERCICIO': r.EXERCICIO || r.exercicio || '',
      'SERIES': r.SERIES || r.series || '',
      'REPETICOES': r.REPETICOES || r.repeticoes || r.reps || '',
      'PESO': r.PESO || r.peso || '',
      'OBS': r.OBS || r.obs || ''
    }));
    const count = _appendRows_(SHEET_HISTORY, prepared, headers);
    return _json({ ok: true, inserted: count });
  } catch (err) {
    return _json({ ok: false, error: err.message || String(err) }, 500);
  }
}

function _json(obj, code) {
  const out = ContentService.createTextOutput(JSON.stringify(obj));
  out.setMimeType(ContentService.MimeType.JSON);
  // CORS note: Web Apps typically include permissive CORS for GET/POST. If needed, leverage HtmlService wrapper.
  if (code) {
    return out; // Apps Script does not support setting HTTP status directly in ContentService
  }
  return out;
}

//----------------------------------------------------
// END Apps Script backend
//----------------------------------------------------

=============================================
3) USE THIS HTML FILE (BELOW)
=============================================
- Save this entire file as, e.g., gym-tracker.html
- Open it on your computer or iPhone (Files ‚Üí tap to open in browser).
- On first load, go to ‚öô Settings and paste your Web App URL.
- Add your daily weights and Save.
-->

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gym Tracker ‚Äî Google Sheets</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#7b8a9a; --fg:#eaf2ff; --accent:#3ba9ff; --ok:#2dd4bf; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,15,20,.95),rgba(11,15,20,.6));backdrop-filter: blur(8px);z-index:10;border-bottom:1px solid #1f2937}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea,button{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #2b3645;background:#0e141d;color:var(--fg);outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent)}
    button{cursor:pointer;background:linear-gradient(180deg,#1b2635,#121a27);border:1px solid #2b3645}
    button.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7);border:0;color:white;font-weight:700}
    button.ghost{background:transparent;border-color:#2b3645}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937;padding:10px;text-align:left}
    th{font-size:12px;color:var(--muted);font-weight:600}
    tr:hover td{background:#0f1621}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0e141d;border:1px solid #2b3645;color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .spacer{flex:1}
    .footer{color:var(--muted);font-size:12px;text-align:center;margin:24px 0}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0e141d;border:1px solid #2b3645;color:#eaf2ff;padding:12px 16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.4);display:none}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:720px){.grid-3{grid-template-columns:1fr}.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="align-items:center;justify-content:space-between">
      <h1>üèãÔ∏è Gym Tracker</h1>
      <div class="toolbar">
        <button class="ghost" id="btn-reload">‚Üª Recarregar</button>
        <button class="ghost" id="btn-settings">‚öôÔ∏è Configura√ß√µes</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="grid-3">
        <div>
          <label for="inp-date">Data</label>
          <input type="date" id="inp-date" />
        </div>
        <div>
          <label for="sel-treino">Treino</label>
          <select id="sel-treino"></select>
        </div>
        <div>
          <label for="sel-serie">S√©rie</label>
          <select id="sel-serie"></select>
        </div>
      </div>
      <div class="row" style="margin-top:16px">
        <div class="spacer"></div>
        <button class="primary" id="btn-generate">Carregar exerc√≠cios</button>
      </div>
    </section>

    <section class="card" id="section-entry" style="display:none">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="pill" id="pill-info">‚Äî</div>
        <div class="toolbar">
          <button class="ghost" id="btn-clear-zeros">Limpar pesos zerados</button>
          <button class="primary" id="btn-save">Salvar no Hist√≥rico</button>
        </div>
      </div>
      <div style="overflow:auto;margin-top:12px">
        <table id="tbl-entry">
          <thead>
            <tr>
              <th>Exerc√≠cio</th>
              <th>S√©ries</th>
              <th>Repeti√ß√µes</th>
              <th>Peso (kg)</th>
              <th>Obs</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="grid-2">
        <div>
          <label for="inp-date-filter">Filtrar hist√≥rico por data</label>
          <input type="date" id="inp-date-filter" />
        </div>
        <div style="display:flex;align-items:end;gap:8px">
          <button id="btn-load-history" class="ghost">Buscar hist√≥rico</button>
          <button id="btn-clear-filter" class="ghost">Limpar filtro</button>
        </div>
      </div>
      <div style="overflow:auto;margin-top:12px">
        <table id="tbl-history">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Data</th>
              <th>Treino</th>
              <th>S√©rie</th>
              <th>Exerc√≠cio</th>
              <th>S√©ries</th>
              <th>Reps</th>
              <th>Peso</th>
              <th>Obs</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card" id="section-settings" style="display:none">
      <h3 style="margin-top:0">Configura√ß√µes</h3>
      <label for="inp-api">URL da API (Web App do Apps Script)</label>
      <input id="inp-api" type="url" placeholder="https://script.google.com/macros/s/AKfycbx.../exec" />
      <div class="row" style="margin-top:12px">
        <button id="btn-save-api" class="primary">Salvar URL</button>
        <button id="btn-test-api" class="ghost">Testar conex√£o</button>
      </div>
    </section>

    <div class="footer">Feito para rodar localmente (desktop e iPhone). Seus dados ficam no Google Sheets.</div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
  // ========= Config =========
  const Store = {
    get api(){ return localStorage.getItem('API_URL') || ''; },
    set api(v){ localStorage.setItem('API_URL', v || ''); }
  };

  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.display = 'block';
    setTimeout(()=> t.style.display = 'none', 2600);
  }

  function today(){
    const d = new Date();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${m}-${day}`;
  }

  // ========= API =========
  async function apiGet(action, params={}){
    if(!Store.api) throw new Error('Configure a URL da API nas Configura√ß√µes.');
    const url = new URL(Store.api);
    url.searchParams.set('action', action);
    Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
    const r = await fetch(url.toString(), { method:'GET' });
    if(!r.ok) throw new Error('Falha na requisi√ß√£o GET');
    return r.json();
  }

  async function apiPost(payload){
    if(!Store.api) throw new Error('Configure a URL da API nas Configura√ß√µes.');
    const r = await fetch(Store.api, {
      method:'POST',
      //headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*',
      //              'Access-Control-Allow-Headers': 'Content-Type' },
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error('Falha na requisi√ß√£o POST');
    return r.json();
  }

  // ========= State =========
  let PLAN = [];

  // ========= UI Populate =========
  function fillTreinoSerieSelectors(){
    const selTreino = document.getElementById('sel-treino');
    const selSerie = document.getElementById('sel-serie');
    const treinos = [...new Set(PLAN.map(r => r['TREINO']))].filter(Boolean);
    selTreino.innerHTML = treinos.map(t => `<option value="${t}">${t}</option>`).join('');
    const series = [...new Set(PLAN.map(r => r['SERIE']))].filter(Boolean);
    selSerie.innerHTML = series.map(s => `<option value="${s}">${s}</option>`).join('');
  }

  function renderEntryRows(){
    const date = document.getElementById('inp-date').value;
    const treino = document.getElementById('sel-treino').value;
    const serie = document.getElementById('sel-serie').value;
    const tbody = document.querySelector('#tbl-entry tbody');
    const rows = PLAN.filter(r => String(r['TREINO'])===treino && String(r['SERIE'])===serie);
    tbody.innerHTML = rows.map(r => `
      <tr data-exercicio="${r['EXERCICIO']}">
        <td>${r['EXERCICIO']}</td>
        <td>${r['SERIES']}</td>
        <td>${r['REPETICOES']}</td>
        <td><input type="number" step="0.5" min="0" placeholder="kg" class="inp-peso" /></td>
        <td><input type="text" placeholder="opcional" class="inp-obs" /></td>
      </tr>
    `).join('');
    document.getElementById('section-entry').style.display = rows.length? 'block':'none';
    document.getElementById('pill-info').textContent = `${date} ‚Ä¢ ${treino} ‚Ä¢ ${serie} ‚Ä¢ ${rows.length} exerc√≠cios`;
  }

  function clearZeroWeights(){
    document.querySelectorAll('.inp-peso').forEach(inp => { if(!inp.value || Number(inp.value) === 0) inp.value = ''; });
  }

  async function saveHistory(){
    const date = document.getElementById('inp-date').value;
    const treino = document.getElementById('sel-treino').value;
    const serie = document.getElementById('sel-serie').value;
    const trs = Array.from(document.querySelectorAll('#tbl-entry tbody tr'));
    const rows = trs.map(tr => {
      const exercicio = tr.getAttribute('data-exercicio');
      const peso = tr.querySelector('.inp-peso').value;
      const obs = tr.querySelector('.inp-obs').value;
      const meta = PLAN.find(r => r['EXERCICIO']===exercicio);
      return {
        DATA: date,
        TREINO: treino,
        SERIE: serie,
        EXERCICIO: exercicio,
        SERIES: meta ? meta['SERIES'] : '',
        REPETICOES: meta ? meta['REPETICOES'] : '',
        PESO: peso || '',
        OBS: obs || ''
      };
    }).filter(r => r.PESO !== '' && Number(r.PESO) >= 0);

    if(!rows.length){ toast('Nada para salvar (todos vazios).'); return; }
    const res = await apiPost({ rows });
    if(res.ok){ toast(`‚úÖ ${res.inserted||rows.length} lan√ßamentos salvos!`); loadHistory(); }
    else { toast('Erro ao salvar: ' + (res.error||'')); }
  }

  function renderHistory(list){
    const tbody = document.querySelector('#tbl-history tbody');
    tbody.innerHTML = list.map(r => `
      <tr>
        <td>${r['TIMESTAMP'] || ''}</td>
        <td>${r['DATA'] || ''}</td>
        <td>${r['TREINO'] || ''}</td>
        <td>${r['SERIE'] || ''}</td>
        <td>${r['EXERCICIO'] || ''}</td>
        <td>${r['SERIES'] || ''}</td>
        <td>${r['REPETICOES'] || ''}</td>
        <td>${r['PESO'] || ''}</td>
        <td>${r['OBS'] || ''}</td>
      </tr>
    `).join('');
  }

  async function loadPlan(){
    const res = await apiGet('plan');
    if(!res.ok) throw new Error(res.error||'Falha ao obter plano');
    PLAN = res.plan || [];
    fillTreinoSerieSelectors();
  }

  async function loadHistory(){
    const date = document.getElementById('inp-date-filter').value;
    const res = await apiGet('history', date? { date } : {});
    if(!res.ok) throw new Error(res.error||'Falha ao obter hist√≥rico');
    renderHistory(res.history||[]);
  }

  // ========= Events =========
  document.getElementById('btn-settings').addEventListener('click', ()=>{
    const s = document.getElementById('section-settings');
    s.style.display = s.style.display === 'none' ? 'block' : 'none';
    if(s.style.display === 'block'){
      document.getElementById('inp-api').value = Store.api;
    }
  });

  document.getElementById('btn-save-api').addEventListener('click', ()=>{
    const url = document.getElementById('inp-api').value.trim();
    if(!/^https:\/\//.test(url)) { toast('Informe uma URL v√°lida iniciando com https://'); return; }
    Store.api = url; toast('URL salva.');
  });

  document.getElementById('btn-test-api').addEventListener('click', async ()=>{
    try{ await loadPlan(); toast('Conex√£o OK. Plano carregado.'); }
    catch(err){ toast('Falha: '+ err.message); }
  });

  document.getElementById('btn-reload').addEventListener('click', async ()=>{
    try{ await loadPlan(); toast('Plano recarregado.'); }
    catch(err){ toast('Falha ao recarregar: '+ err.message); }
  });

  document.getElementById('btn-generate').addEventListener('click', ()=>{
    renderEntryRows();
  });

  document.getElementById('btn-clear-zeros').addEventListener('click', clearZeroWeights);
  document.getElementById('btn-save').addEventListener('click', ()=>{
    saveHistory().catch(err => toast('Erro: '+err.message));
  });

  document.getElementById('btn-load-history').addEventListener('click', ()=>{
    loadHistory().catch(err => toast('Erro: '+err.message));
  });

  document.getElementById('btn-clear-filter').addEventListener('click', ()=>{
    document.getElementById('inp-date-filter').value = '';
    loadHistory().catch(err => toast('Erro: '+err.message));
  });

  // ========= Init =========
  (function init(){
    document.getElementById('inp-date').value = today();
    document.getElementById('inp-date-filter').value = '';
    if(Store.api){
      loadPlan().then(()=> loadHistory()).catch(err => toast('Configurar API: '+err.message));
    } else {
      toast('Abra Configura√ß√µes e cole a URL do Web App');
    }
  })();
  </script>
</body>
</html>
